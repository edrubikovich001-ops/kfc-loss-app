<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>KFC Loss Control - Pro</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Excel (клиентская генерация с автофильтром/сортировкой). -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');

    :root{
      --ios-blue:#0A84FF;
      --kfc-red:#E4002B;
      --item-height:52px;

      --px: 0px;
      --py: 0px;
      --ps: 0px;

      --ax: 0px;
      --ay: 0px;
      --shine: 0.18;

      --sx: 50%;
      --sy: 40%;
      --sop: .0;

      --lx: 50%;
      --ly: 40%;
      --lpress: 0;

      --hdrShift: 0px;

      /* iOS height stability */
      --appH: 100vh;
    }

    html,body{height:100%;}
    body{
      font-family:'Inter',-apple-system,sans-serif;
      background:#000;
      color:#fff;
      margin:0;
      overflow:hidden;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      -webkit-touch-callout:none;
    }

    /* ===== ДИНАМИЧНЫЙ ФОН ===== */
    #bg{
      position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;
      background:
        radial-gradient(1200px 820px at 18% 28%, rgba(58,140,230,.30), transparent 60%),
        radial-gradient(980px 760px at 82% 22%, rgba(98,44,170,.28), transparent 60%),
        radial-gradient(980px 860px at 70% 82%, rgba(170,64,170,.22), transparent 58%),
        radial-gradient(1100px 760px at 24% 86%, rgba(36,70,160,.26), transparent 58%),
        linear-gradient(180deg, rgba(0,0,0,.34), rgba(0,0,0,.72));
    }

    #bg::before, #bg::after{
      content:"";
      position:absolute;
      inset:-38%;
      background:
        radial-gradient(closest-side at 22% 34%, rgba(58,140,230,.58), transparent 54%),
        radial-gradient(closest-side at 76% 24%, rgba(98,44,170,.52), transparent 54%),
        radial-gradient(closest-side at 70% 80%, rgba(170,64,170,.44), transparent 58%),
        radial-gradient(closest-side at 30% 86%, rgba(36,70,160,.56), transparent 58%);
      filter: blur(18px) saturate(150%);
      opacity: .98;
      will-change: transform, filter, opacity;
      transform: translate3d(0,0,0);
    }

    #bg::before{
      mix-blend-mode: screen;
      animation: auroraFlowA 4.9s ease-in-out infinite;
      transform:
        translate3d(
          calc(var(--px) * 0.78 + var(--ps) * 0.16 + var(--ax) * 1.85),
          calc(var(--py) * 0.78 + var(--ps) * 0.30 + var(--ay) * 1.85),
          0
        )
        scale(1.06);
    }

    #bg::after{
      opacity:.84;
      filter: blur(40px) saturate(170%);
      mix-blend-mode: screen;
      animation: auroraFlowB 6.7s ease-in-out infinite;
      transform:
        translate3d(
          calc(var(--px) * 1.02 + var(--ps) * 0.24 + var(--ax) * 2.25),
          calc(var(--py) * 1.02 + var(--ps) * 0.42 + var(--ay) * 2.25),
          0
        )
        scale(1.10);
    }

    #bg-pulse{
      position:fixed; inset:-18%; z-index:2; pointer-events:none;
      background:
        radial-gradient(860px 620px at 26% 28%, rgba(255,255,255,.24), transparent 62%),
        radial-gradient(980px 760px at 70% 34%, rgba(140,200,255,.24), transparent 64%),
        radial-gradient(1040px 820px at 62% 84%, rgba(255,42,74,.18), transparent 68%);
      mix-blend-mode: screen;
      filter: blur(10px);
      will-change: transform, opacity;
      opacity: calc(0.16 + var(--shine));
      animation: pulseWave 2.7s ease-in-out infinite;
      transform:
        translate3d(
          calc(var(--px) * 0.64 + var(--ax) * 1.55),
          calc(var(--py) * 0.64 + var(--ay) * 1.55),
          0
        );
    }

    /* ===== НОВЫЕ ПОЛОСКИ: медленнее + больше шаг + волнистые ===== */
    #bg-lines{
      position:fixed; inset:0; z-index:1; pointer-events:none;
      opacity:.26;

      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,.26) 0px,
          rgba(255,255,255,.26) 1px,
          transparent 1px,
          transparent 34px
        );

      -webkit-mask-image:
        radial-gradient(900px 900px at 50% 42%, rgba(0,0,0,1), rgba(0,0,0,0)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='520'%3E%3Cfilter id='d'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.012' numOctaves='2' seed='7'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='18'/%3E%3C/filter%3E%3Crect width='520' height='520' fill='white' filter='url(%23d)' opacity='1'/%3E%3C/svg%3E");
      -webkit-mask-size: auto, 520px 520px;
      -webkit-mask-repeat: no-repeat, repeat;
      -webkit-mask-position: center, 0 0;

      mask-image:
        radial-gradient(900px 900px at 50% 42%, rgba(0,0,0,1), rgba(0,0,0,0)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='520'%3E%3Cfilter id='d'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.012' numOctaves='2' seed='7'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='18'/%3E%3C/filter%3E%3Crect width='520' height='520' fill='white' filter='url(%23d)' opacity='1'/%3E%3C/svg%3E");
      mask-size: auto, 520px 520px;
      mask-repeat: no-repeat, repeat;
      mask-position: center, 0 0;

      will-change: transform, opacity, filter, background-position, -webkit-mask-position, mask-position;
      mix-blend-mode: overlay;
      animation: linesWaveSlow 6.8s ease-in-out infinite;

      transform:
        translate3d(
          calc(var(--px) * 0.22 + var(--ax) * 0.70),
          calc(var(--py) * 0.22 + var(--ay) * 0.70),
          0
        );
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
    }

    @keyframes linesWaveSlow{
      0%{
        opacity:.22;
        filter: blur(0px) brightness(1.02);
        background-position: 0% 54%;
        -webkit-mask-position: center, 0px 0px;
        mask-position: center, 0px 0px;
      }
      50%{
        opacity:.30;
        filter: blur(.35px) brightness(1.16);
        background-position: 100% 46%;
        -webkit-mask-position: center, 60px -40px;
        mask-position: center, 60px -40px;
      }
      100%{
        opacity:.24;
        filter: blur(0px) brightness(1.04);
        background-position: 0% 54%;
        -webkit-mask-position: center, 0px 0px;
        mask-position: center, 0px 0px;
      }
    }

    #bg-noise{
      position:fixed; inset:0; z-index:2; pointer-events:none;
      opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='https://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      will-change: transform, opacity;
      animation: noiseMove 4.6s steps(6) infinite;
      transform: translate3d(calc(var(--ax) * 0.44), calc(var(--ay) * 0.44), 0);
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
    }

    @keyframes auroraFlowA{
      0%   { filter: blur(16px) saturate(155%); opacity:.96; }
      50%  { filter: blur(24px) saturate(205%); opacity:1; }
      100% { filter: blur(16px) saturate(165%); opacity:.96; }
    }
    @keyframes auroraFlowB{
      0%   { filter: blur(36px) saturate(170%); opacity:.78; }
      50%  { filter: blur(46px) saturate(220%); opacity:.98; }
      100% { filter: blur(36px) saturate(180%); opacity:.82; }
    }
    @keyframes pulseWave{
      0%   { transform: translate3d(calc(var(--px) * 0.64 + var(--ax) * 1.55 - 24px), calc(var(--py) * 0.64 + var(--ay) * 1.55 + 12px), 0) scale(1.04); }
      50%  { transform: translate3d(calc(var(--px) * 0.64 + var(--ax) * 1.55 + 34px), calc(var(--py) * 0.64 + var(--ay) * 1.55 - 22px), 0) scale(1.11); }
      100% { transform: translate3d(calc(var(--px) * 0.64 + var(--ax) * 1.55 - 18px), calc(var(--py) * 0.64 + var(--ay) * 1.55 + 18px), 0) scale(1.06); }
    }
    @keyframes noiseMove{
      0%{ transform: translate3d(calc(var(--ax) * 0.44), calc(var(--ay) * 0.44), 0); }
      100%{ transform: translate3d(calc(var(--ax) * 0.44 - 54px), calc(var(--ay) * 0.44 + 30px), 0); }
    }

    /* ===== SPOTLIGHT ===== */
    #spotlight{
      position:fixed; inset:0; z-index:3; pointer-events:none;
      opacity: var(--sop);
      transition: opacity .22s ease;
      background:
        radial-gradient(600px 500px at var(--sx) var(--sy),
          rgba(255,255,255,.20),
          rgba(160,210,255,.14) 28%,
          rgba(255,42,74,.10) 48%,
          transparent 70%);
      mix-blend-mode: screen;
    }

    /* ===== “жидкое стекло” текст ===== */
    .glass-ui h1,.glass-ui h2,.glass-ui h3,.glass-ui p,.glass-ui span,.glass-ui button,.glass-ui label,.glass-ui small{
      color: rgba(255,255,255,.92);
      text-shadow:
        0 0 10px rgba(255,255,255,.08),
        0 0 26px rgba(140,200,255,.10),
        0 1px 0 rgba(0,0,0,.35);
      -webkit-text-stroke: 0.2px rgba(255,255,255,.08);
    }
    .glass-ui input,.glass-ui textarea{ -webkit-text-stroke: 0; text-shadow:none; }

    .glass-shimmer{
      background: linear-gradient(90deg, rgba(255,255,255,.78), rgba(195,230,255,.98), rgba(255,255,255,.62), rgba(255,255,255,.88));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      background-size: 240% 100%;
      animation: shimmer 5.6s ease-in-out infinite;
      text-shadow: 0 0 12px rgba(255,255,255,.06), 0 0 22px rgba(140,200,255,.10), 0 1px 0 rgba(0,0,0,.35);
      -webkit-text-stroke: 0.25px rgba(255,255,255,.08);
    }
    @keyframes shimmer{ 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }

    /* ===== Карточки ===== */
    .ios-card{
      background:rgba(28,28,30,.76);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .ios-card.border-live::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:18px;
      padding:1px;
      background: linear-gradient(120deg, rgba(255,42,74,.72), rgba(160,210,255,.62), rgba(34,197,94,.48), rgba(255,255,255,.18), rgba(255,42,74,.62));
      background-size: 240% 240%;
      animation: borderFlow 7.2s ease-in-out infinite;
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: .56;
      pointer-events:none;
    }
    @keyframes borderFlow{ 0%{background-position:0% 50%;} 50%{background-position:100% 50%;} 100%{background-position:0% 50%;} }

    .ios-card::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius:18px;
      background: radial-gradient(650px 240px at 20% 10%, rgba(255,255,255,.10), transparent 55%),
                  radial-gradient(540px 280px at 85% 30%, rgba(140,200,255,.10), transparent 60%),
                  radial-gradient(650px 280px at 55% 90%, rgba(255,42,74,.08), transparent 60%);
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .card-anim{
      transition: transform .12s ease, box-shadow .16s ease, border-color .16s ease;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      will-change: transform;
    }
    .card-anim:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    .card-anim:hover::after{ opacity:1; }
    .card-anim:active{
      transform: translateY(0px) scale(0.985);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .card-anim:active::after{ opacity:.80; }

    /* ===== Живая линза ===== */
    .lens-card{ isolation:isolate; }
    .lens-card .lens-layer{
      position:absolute; inset:-2px;
      border-radius:18px;
      pointer-events:none;
      z-index:2;
      opacity:.0;
      transition: opacity .12s ease;
    }
    .lens-card .lens-layer::before{
      content:"";
      position:absolute; inset:0;
      border-radius:18px;
      background:
        radial-gradient(560px 420px at var(--lx) var(--ly), rgba(255,255,255,.22), rgba(140,200,255,.16) 28%, rgba(255,42,74,.11) 46%, transparent 70%),
        repeating-linear-gradient(135deg, rgba(255,255,255,.07) 0px, rgba(255,255,255,.07) 1px, transparent 1px, transparent 13px);
      mix-blend-mode: screen;
      opacity: .86;
    }
    .lens-card .lens-layer::after{
      content:"";
      position:absolute; inset:0;
      border-radius:18px;
      background: radial-gradient(460px 300px at calc(var(--lx) + 7%) calc(var(--ly) + 5%), rgba(255,255,255,.13), transparent 62%);
      backdrop-filter: blur(20px) saturate(175%) contrast(114%);
      -webkit-backdrop-filter: blur(20px) saturate(175%) contrast(114%);
      opacity:.80;
      transform: translate3d(calc((var(--lpress) * 0.6px)), calc((var(--lpress) * 0.6px)), 0);
    }
    .lens-card:hover .lens-layer{ opacity:.44; }
    .lens-card:active .lens-layer{ opacity:.62; }
    @media (hover:none){ .lens-card .lens-layer{ opacity:.22; } .lens-card:active .lens-layer{ opacity:.46; } }

    /* ===== Кнопки “жидкие” ===== */
    .btn-liquid{
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(14px);
      transition: transform .10s ease, box-shadow .14s ease, border-color .14s ease;
      will-change: transform;
    }
    .btn-liquid::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(closest-side at 30% 30%, rgba(255,255,255,.25), transparent 60%),
                  radial-gradient(closest-side at 70% 40%, rgba(160,210,255,.20), transparent 65%);
      opacity:.0;
      transform: translate3d(-10%, -10%, 0);
      transition: opacity .12s ease, transform .16s ease;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .btn-liquid::after{
      content:"";
      position:absolute;
      left:-60%;
      top:-30%;
      width:60%;
      height:160%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      transform: skewX(-18deg);
      opacity:0;
      pointer-events:none;
    }
    .btn-liquid:hover{ border-color: rgba(255,255,255,.18); box-shadow: 0 14px 34px rgba(0,0,0,.45); }
    .btn-liquid:hover::before{ opacity:.48; transform: translate3d(0,0,0); }
    .btn-liquid:active{ transform: scale(0.986); }
    .btn-liquid:active::before{ opacity:.74; }
    .btn-liquid:active::after{ opacity:1; animation: btnShine .44s ease-out; }
    @keyframes btnShine{ 0%{left:-60%;opacity:0;} 10%{opacity:1;} 100%{left:130%;opacity:0;} }

    main{
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scroll-behavior: smooth;
      touch-action: pan-y;
      contain: paint;
    }
    main::-webkit-scrollbar{display:none;}

    /* ===== iPhone FIX (НЕ меняет дизайн) ===== */
    body.is-scrolling .card-anim,
    body.is-scrolling .btn-liquid{
      transition: none !important;
      transform: none !important;
      box-shadow: none !important;
    }
    body.is-scrolling .ios-card::after{ transition:none !important; }

    /* ВО ВРЕМЯ СКРОЛЛА (iOS): заморозка тяжёлых эффектов, визуально почти незаметно */
    body.is-scrolling #bg::before,
    body.is-scrolling #bg::after,
    body.is-scrolling #bg-lines,
    body.is-scrolling #bg-noise,
    body.is-scrolling #bg-pulse{
      animation-play-state: paused !important;
    }
    body.is-scrolling .lens-card .lens-layer{
      opacity: 0 !important;
      transition: none !important;
    }
    body.is-scrolling #spotlight{
      opacity: 0 !important;
      transition: none !important;
    }

    .wheel-box{display:flex;align-items:center;background:rgba(44,44,46,.86);border-radius:12px;height:var(--item-height);padding:0 10px;border:1px solid rgba(255,255,255,.12);}
    .wheel{height:var(--item-height);overflow-y:scroll;scroll-snap-type:y mandatory;scrollbar-width:none;width:44px;text-align:center;}
    .wheel::-webkit-scrollbar{display:none;}
    .wheel-item{height:var(--item-height);display:flex;align-items:center;justify-content:center;scroll-snap-align:center;font-size:22px;font-weight:600;color:#444;transition:all .2s;}
    .wheel-item.active{color:var(--ios-blue);font-weight:800;transform:scale(1.1);}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
    .day-btn{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:500;border-radius:12px;cursor:pointer;color:#ccc;}
    .day-btn.selected{background:var(--ios-blue)!important;color:#fff!important;font-weight:700;}
    .day-btn.range{background:rgba(10,132,255,.2);color:#fff;}
    .ios-select{background:rgba(44,44,46,.86);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:14px;font-weight:600;}
    .tab-btn{flex:1;padding:12px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:rgba(255,255,255,.55);border-bottom:2px solid transparent;transition:all .20s;}
    .tab-btn.active{color:#fff;border-bottom-color:var(--kfc-red);}
    .progress-bar{height:4px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden;margin-top:8px;}
    .progress-fill{height:100%;background:var(--kfc-red);border-radius:2px;}
    #sum-input{background:transparent;color:var(--kfc-red);font-weight:900;text-align:center;border:none;outline:none;width:100%;}
    .draft-badge{background:#E4002B;color:#fff;padding:2px 6px;border-radius:4px;font-size:8px;font-weight:900;text-transform:uppercase;}

    .search-hint{font-size:9px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.35);margin:0 2px 10px;}
    .search-box{
      display:flex;align-items:center;gap:10px;
      padding:12px 14px;border-radius:14px;
      background:rgba(28,28,30,.70);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(14px);
      margin-bottom:14px;
      position:relative;
      overflow:hidden;
    }
    .search-box::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(420px 220px at 20% 20%, rgba(255,255,255,.12), transparent 62%),
                  radial-gradient(420px 240px at 80% 40%, rgba(160,210,255,.10), transparent 66%);
      opacity:.7;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .search-box input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:#fff;
      font-weight:700;
      font-size:13px;
      position:relative;
      z-index:1;
    }

    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:22px; z-index:9999;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px; font-weight:700;
      color:#fff;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    .btn-edit{
      background: linear-gradient(180deg, rgba(10,132,255,.30), rgba(10,132,255,.12));
      border: 1px solid rgba(10,132,255,.38);
      color:#e9f4ff;
    }
    .btn-delete{
      background: linear-gradient(180deg, rgba(228,0,43,.26), rgba(228,0,43,.10));
      border: 1px solid rgba(228,0,43,.38);
      color:#ffe8ee;
    }
    .btn-excel{
      background: linear-gradient(180deg, rgba(34,197,94,.24), rgba(34,197,94,.10));
      border: 1px solid rgba(34,197,94,.36);
      color:#eafff1;
    }

    .header-glass{
      background:
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.035)),
        radial-gradient(700px 320px at 25% 0%, rgba(160,210,255,.18), transparent 60%),
        radial-gradient(700px 320px at 80% 5%, rgba(255,42,74,.12), transparent 62%);
      backdrop-filter: blur(18px) saturate(175%) contrast(110%);
      -webkit-backdrop-filter: blur(18px) saturate(175%) contrast(110%);
      border-bottom: 1px solid rgba(255,255,255,.10);
      box-shadow:
        0 16px 44px rgba(0,0,0,.38),
        inset 0 1px 0 rgba(255,255,255,.14);
      position:relative;
      overflow:hidden;
      transform: translate3d(0,0,0);
      contain: paint;
    }
    .header-glass::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(540px 260px at 20% 10%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(520px 280px at 90% 30%, rgba(160,210,255,.14), transparent 64%),
        radial-gradient(520px 260px at 55% 120%, rgba(255,42,74,.08), transparent 70%);
      mix-blend-mode: screen;
      opacity:.85;
      pointer-events:none;
      transform: translate3d(calc(var(--px) * 0.14), calc(var(--py) * 0.14), 0);
      will-change: transform;
      backface-visibility:hidden;
      -webkit-backface-visibility:hidden;
    }
    .header-glass .hdr-noise{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.16;
      mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='https://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      transform: translate3d(calc(var(--ax) * 0.20), calc(var(--ay) * 0.20), 0);
      will-change: transform;
    }
    .header-glass::after{
      content:"";
      position:absolute;
      left:-40%;
      top:-60%;
      width:80%;
      height:220%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: skewX(-18deg);
      opacity:.55;
      animation: headerShine 6.4s ease-in-out infinite;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    @keyframes headerShine{
      0%{ left:-60%; opacity:.10; }
      40%{ opacity:.62; }
      60%{ opacity:.40; }
      100%{ left:140%; opacity:.10; }
    }

    /* Wrapper height stabilization (visual 1:1) */
    .app-shell{ height: var(--appH); }

    /* ===========================================================
       ANDROID PERF MODE (Android-only): убираем тяжёлый фон/overlay,
       не трогая iOS-визуал вообще.
       =========================================================== */
    body.android #bg,
    body.android #bg-lines,
    body.android #bg-noise,
    body.android #bg-pulse,
    body.android #spotlight{
      display:none !important;
    }
    body.android main{ scroll-behavior:auto !important; }
  </style>
</head>

<body>
  <div id="bg"></div>
  <div id="bg-lines"></div>
  <div id="bg-noise"></div>
  <div id="bg-pulse"></div>
  <div id="spotlight"></div>
  <div id="toast"></div>

  <div class="app-shell glass-ui max-w-[430px] mx-auto flex flex-col relative overflow-hidden z-10">
    <header class="header-glass pt-12 pb-4 px-6 flex items-center justify-between sticky top-0 z-50">
      <div class="hdr-noise"></div>

      <div class="flex items-center gap-4 relative z-10">
        <button id="back-btn" onclick="goBack()" class="hidden w-10 h-10 flex items-center justify-center rounded-full bg-white/5 btn-liquid">
          <i data-lucide="chevron-left" class="text-blue-200"></i>
        </button>

        <div class="flex flex-col">
          <h1 id="header-title" class="text-xl font-black uppercase tracking-tighter glass-shimmer">KFC</h1>
          <p class="text-[9px] font-bold tracking-[0.2em] uppercase" style="color:#ff2a4a;">LOSS CONTROL</p>
        </div>
      </div>

      <div class="flex items-center gap-2 relative z-10">
        <!-- Android: явная кнопка "Добавить на экран" (Telegram Mini Apps API). -->
        <button id="a2hs-btn" onclick="addToHomeScreen()" class="hidden text-gray-200/70 transition-transform btn-liquid w-10 h-10 rounded-full flex items-center justify-center" title="Добавить на экран">
          <i data-lucide="smartphone" class="w-5 h-5"></i>
        </button>

        <button onclick="refreshFromServer()" class="text-gray-200/70 transition-transform btn-liquid w-10 h-10 rounded-full flex items-center justify-center" title="Обновить">
          <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <main id="view-container" class="flex-1 overflow-y-auto px-6 py-6 pb-48"></main>

    <footer id="footer-actions" class="px-6 py-8 fixed bottom-0 left-0 right-0 max-w-[430px] mx-auto hidden z-50 bg-black/30 backdrop-blur-xl border-t border-white/5">
      <div class="flex flex-col gap-3">
        <button id="later-btn" onclick="saveDraft()" class="w-full py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest bg-white/10 btn-liquid">
          Завершить позже
        </button>
        <button id="primary-btn" class="w-full bg-[#E4002B] text-white py-4 rounded-2xl font-bold text-lg uppercase tracking-tight shadow-2xl btn-liquid">
          Далее
        </button>
      </div>
    </footer>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { try { tg.ready(); tg.expand(); } catch (_) {} }
  const API = "/api";

  /* ===== iOS detection ===== */
  const isIOS = (() => {
    const ua = navigator.userAgent || "";
    const iOS = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    return iOS || iPadOS;
  })();

  /* ===== Android detection (Android-only perf mode) ===== */
  const isAndroid = (() => {
    const ua = navigator.userAgent || "";
    return /Android/i.test(ua);
  })();
  if (isAndroid) {
    document.body.classList.add('android');
  }

  /* ===== Stable height for iOS (no jumping with bars) ===== */
  (function bindViewportHeight(){
    const root = document.documentElement;
    function setAppH(){
      const h = window.innerHeight || 0;
      if (h > 0) root.style.setProperty('--appH', h + 'px');
    }
    setAppH();
    window.addEventListener('resize', setAppH, { passive:true });
    window.addEventListener('orientationchange', setAppH, { passive:true });
  })();

  (function applyIosScrollFix(){
    const main = document.getElementById('view-container');
    if (!main) return;
    if (isIOS) {
      // iOS WebView часто дергается от scroll-behavior:smooth
      main.style.scrollBehavior = 'auto';
    }
  })();

  /* ===== Smarter iOS scroll stability (freeze heavy work during scroll/inertia) ===== */
  let __scrollLastTs = 0;
  let __scrolling = false;

  (function bindIosScrollStability(){
    const main = document.getElementById('view-container');
    if(!main) return;

    let t = null;
    main.addEventListener('scroll', () => {
      __scrollLastTs = performance.now();
      if (!isIOS) return;
      if (!__scrolling) {
        __scrolling = true;
        document.body.classList.add('is-scrolling');
      }
      clearTimeout(t);
      // leave a bit longer to cover inertia end
      t = setTimeout(() => {
        // actual stop is decided in RAF too; this is just a backup
        __scrolling = false;
        document.body.classList.remove('is-scrolling');
      }, 240);
    }, { passive:true });
  })();

  const monthNames = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
  const monthNamesGenitive = ["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];

  const dataTU = {
    "Alyona Rainskaya": ["12741 — KFC Baizar Mall","12714 — KFC Essentai Mall","12750 — KFC Alem Plaza","12757 — KFC Neftek","12768 — KFC KazGu Almaty","12806 — KFC NASIKHA ATYRAU","12815 — KFC INFINITY MALL ATYRAU"],
    "Andrey Nacharov": ["12736 — KFC Batyr Mall","12737 — KFC Sarayarka","12751 — KFC UST Kamenogorsk","12772 — KFC Kutuzova Pavlodar","12783 — KFC MAXI MALL EKIBASTUZ","12784 — KFC MAXI MALL OSKEMEN","12787 — KFC Koschi","12825 — KFC CENTRAL PARK SEMEY"],
    "Artyom Denissenko": ["12708 — KFC Khan Shatour","12720 — KFC Respblika","12724 — KFC Mechta","12733 — KFC Asia Park","12796 — KFC Magnum Edil","12803 — KFC VSTRECHA","12821 — KFC ZHYBEK ZHOLY COMPASS","12827 — KFC KOKSHETAU AUEZOVA","12830 — KFC NURLY ZHOL ASTANA"],
    "Igor Sokharev": ["12710 — KFC Keruen","12726 — KFC Oasis","12782 — KFC NOMAD NEW","12786 — KFC Mart, Kostanay city","12809 — KFC DOSTYK MALL PETROPAVLOVSK","12826 — KFC KOSTANAY PLAZA"],
    "Irina Zelenkevich": ["12716 — KFC Merey","12740 — KFC Aktau","12754 — KFC AK KALA MALL","12763 — KFC Shum Mall - Aktau","12778 — KFC Atameken","12780 — KFC Mart Taraz","12791 — KFC Kyzylorda","12829 — KFC ZHAISAN"],
    "Lolokhon Makhmudova": ["12712 — KFC Googla","12722 — KFC Dostik Plaza","12743 — KFC Baluan Sholak","12746 — KFC Forum Mall","12779 — KFC Mart Almaty","12795 — KFC Globus","12811 — KFC APORT KULDZHA","12813 — KFC RP DOSTYK","12842 — KFC YASSY APARTMENTS TURKESTAN"],
    "Nikol Tyurina": ["12810 — KFC Temirtau","12710 — KFC Keruen city Astana","12715 — KFC City Mall Karaganda","12723 — KFC Bogembay","12728 — KFC Green","12731 — KFC Flag Karaganda","12755 — KFC LITE ASTRAHANKA","12814 — KFC SYGANAK","12818 — KFC FOODCITY ASTANA"],
    "Nurlan Ataibekov": ["12703 — KFC Mega Almaty","12704 — KFC Domillion","12713 — KFC Aport","12732 — KFC Adem","12761 — KFC Kulager","12770 — KFC Ainabulak","12790 — KFC Kaskelen","12808 — KFC COMPASS BISHKEK HIGHWAY","12816 — KFC APORT MIAMI"],
    "Tolkinbek Zulpykhar": ["12820 — KFC Dalida Mall Aktobe","12706 — KFC Manasa","12738 — KFC GOLDEN KEY","12745 — KFC Mega Expo","12747 — KFC Central Stadium - Akotobe","12753 — KFC Keruen City Mall - Aktobe","12828 — KFC INCITY ASTANA"],
    "Ulan Toiganbayev": ["12709 — KFC Maxima","12711 — KFC ADK","12725 — KFC Mega Park","12729 — KFC Tole Bi","12730 — KFC Moscow Mall","12756 — KFC SILKWAY CITY","12773 — KFC TSUM","12798 — KFC Compass","12804 — KFC GRES"],
    "Valeriya Toishiyeva": ["12839 — KFC Shymkent Tashkent RP","12748 — KFC Shymkent Plaza","12758 — KFC VAZ","12760 — KFC LEMON","12777 — KFC Sever - Shymkent City","12824 — KFC MEGA MALL SHYMKENT","12832 — KFC ALMATY AIRPORT","12839 — KFC SHYMKENT TASHKENT RP","12841 — KFC DALA MALL SHYMKENT"],
    "Zhaidary Talapova": ["12734 — KFC ATAKENT","12774 — KFC Asia Park Almaty","12775 — KFC MAGNUM - RELOCATION","12776 — KFC Malika","12799 — KFC Saryarka Almaty","12800 — KFC Masato","12801 — KFC Aksai","12807 — KFC SPUTNIK MALL","12819 — KFC GRAND PARK ALMATY"]
  };

  const STORAGE_KEY = 'kfc_loss_pro_v12';
  let db = { reports: [], drafts: [] };
  try { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; db.drafts = Array.isArray(saved.drafts) ? saved.drafts : []; }
  catch (_) { db.drafts = []; }

  function saveDraftsToLS() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ drafts: db.drafts })); }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function getNowObj(){ const d=new Date(); return { day:d.getDate(), month:d.getMonth(), year:d.getFullYear(), hour:d.getHours(), min:d.getMinutes(), ts:d.getTime() }; }

  function parseRuDateTime(str){
    if(!str||typeof str!=="string") return null;
    const m=str.trim().match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})\s+(\d{1,2}):(\d{1,2})$/);
    if(!m) return null;
    const dd=Number(m[1]), mm=Number(m[2]), yy=Number(m[3]), hh=Number(m[4]), mi=Number(m[5]);
    const dt=new Date(yy, mm-1, dd, hh, mi);
    if(Number.isNaN(dt.getTime())) return null;
    return { day:dd, month:mm-1, year:yy, hour:hh, min:mi, ts:dt.getTime() };
  }

  function normalizeServerReport(r){
    const startObj=parseRuDateTime(r.start)||getNowObj();
    const endObj=parseRuDateTime(r.end)||startObj;
    return { id:Number(r.id), manager:r.manager||'', restaurant:r.restaurant||'', reason:r.reason||'', comment:r.comment||'', amount:Number(r.amount)||0,
      start:startObj, end:endObj, created_at:Number(r.created_at)||startObj.ts };
  }

  function dedupeReportsById(reports){
    const m=new Map();
    for(const r of (reports||[])){
      if(!r || typeof r.id!=="number") continue;
      const prev=m.get(r.id);
      if(!prev || (Number(r.created_at||0) > Number(prev.created_at||0))) m.set(r.id, r);
    }
    return Array.from(m.values());
  }

  function toast(msg){
    const el=document.getElementById('toast'); if(!el) return;
    el.textContent=msg; el.classList.add('show');
    clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove('show'), 1400);
  }

  const HAPTIC = tg?.HapticFeedback;
  let _hLast=0;
  function hapticImpact(style="light"){ try{ const now=Date.now(); if(now-_hLast<70) return; _hLast=now; HAPTIC?.impactOccurred?.(style);}catch(_){} }
  function hapticSelect(){ try{ const now=Date.now(); if(now-_hLast<70) return; _hLast=now; HAPTIC?.selectionChanged?.();}catch(_){} }
  document.addEventListener('click',(e)=>{ const btn=e.target?.closest?.('button'); if(!btn) return; hapticImpact(btn.classList.contains('btn-delete')?"medium":"light"); },{passive:true});

  async function apiJson(url, options = {}, timeoutMs = 9000){
    const controller=new AbortController(); const t=setTimeout(()=>controller.abort(), timeoutMs);
    const opt={...options, signal:controller.signal};
    try{
      const resp=await fetch(url,opt);
      const data=await resp.json().catch(()=>({}));
      if(!resp.ok||!data.ok) throw new Error(data.error||`HTTP ${resp.status}`);
      return data;
    } finally { clearTimeout(t); }
  }

  async function loadReportsFromServer(){
    const data=await apiJson(`${API}/reports`,{method:"GET"},12000);
    const normalized=(data.reports||[]).map(normalizeServerReport);
    db.reports=dedupeReportsById(normalized);
  }

  function safePopup(title,message){
    if(!tg) return;
    try{
      if(tg.isPopupOpened) return;
      if(typeof tg.showPopup==="function") tg.showPopup({ title, message, buttons:[{type:"ok"}] });
    }catch(_){}
  }

  async function refreshFromServer(){
    toast("Обновляю...");
    try{ await loadReportsFromServer(); render(); safePopup("Готово","Данные обновлены с сервера."); hapticImpact("light"); }
    catch(e){ toast("Ошибка"); alert("Не удалось обновить данные: "+(e?.message||e)); }
  }

  let state={
    view:'main', manager:'', restaurant:'', reason:'', comment:'',
    start:null, end:null, stage:'start', amount:0,
    filter:'all', analyticsCal:{ month:new Date().getMonth(), year:new Date().getFullYear(), start:null, end:null },
    analyticsTab:'restaurants', draftId:null, editId:null,
    searchManager:'', searchRestaurant:'',
    homeScreenStatus: null,
    clientRequestId: null
  };
  let historyStack=['main'];

  function setPrimary(label, handler, showFooter=true, showLater=true){
    const footer=document.getElementById('footer-actions');
    const laterBtn=document.getElementById('later-btn');
    const primaryBtn=document.getElementById('primary-btn');
    if(showFooter) footer.classList.remove('hidden'); else footer.classList.add('hidden');
    if(showLater) laterBtn.classList.remove('hidden'); else laterBtn.classList.add('hidden');

    primaryBtn.disabled=false;
    primaryBtn.classList.remove('opacity-40');
    primaryBtn.innerText=label;

    primaryBtn.onclick=()=>{
      if(primaryBtn.disabled) return;
      hapticImpact("light");
      handler();
    };
  }

  let renderScheduled=false;
  function scheduleRenderPreserveFocus(activeId, selStart, selEnd){
    if(renderScheduled) return;
    renderScheduled=true;
    requestAnimationFrame(()=>{ renderScheduled=false; render();
      if(activeId){
        const el=document.getElementById(activeId);
        if(el && typeof el.focus==='function'){
          el.focus({preventScroll:true});
          try{ if(typeof selStart==='number' && typeof selEnd==='number' && el.setSelectionRange) el.setSelectionRange(selStart, selEnd); }catch(_){}
        }
      }
    });
  }
  function updateSearch(field,value,inputId){
    const el=document.getElementById(inputId);
    const selStart=el && typeof el.selectionStart==='number'?el.selectionStart:null;
    const selEnd=el && typeof el.selectionEnd==='number'?el.selectionEnd:null;
    state[field]=value;
    scheduleRenderPreserveFocus(inputId, selStart, selEnd);
  }

  let _iconsScheduled=false;
  function scheduleIcons(){
    if(_iconsScheduled) return;
    _iconsScheduled=true;
    requestAnimationFrame(()=>{ _iconsScheduled=false; try{ lucide.createIcons(); }catch(_){ } });
  }

  /* ===== Android: Add to Home Screen (Telegram API) ===== */
  function supportsHomeScreen(){
    return !!(tg && isAndroid && typeof tg.addToHomeScreen === "function" && typeof tg.checkHomeScreenStatus === "function");
  }

  function updateA2HSButton(){
    const btn=document.getElementById('a2hs-btn');
    if(!btn) return;

    if(!supportsHomeScreen()){
      btn.classList.add('hidden');
      return;
    }

    // Показываем кнопку, если не "added".
    const st = state.homeScreenStatus;
    if(st === 'added'){
      btn.classList.add('hidden');
    } else {
      btn.classList.remove('hidden');
    }
  }

  function bindHomeScreenStatus(){
    if(!supportsHomeScreen()) return;

    try{
      tg.checkHomeScreenStatus((status)=>{
        state.homeScreenStatus = status || null;
        updateA2HSButton();
        scheduleIcons();
      });
    }catch(_){}

    try{
      tg.onEvent?.('homeScreenAdded', ()=>{
        state.homeScreenStatus = 'added';
        toast("Ярлык добавлен.");
        updateA2HSButton();
      });
    }catch(_){}
  }

  function addToHomeScreen(){
    if(!supportsHomeScreen()){
      toast("Не поддерживается.");
      return;
    }

    // Варианты статуса: unsupported / unknown / added / missed.
    const st = state.homeScreenStatus;
    if(st === 'unsupported'){
      toast("Не поддерживается.");
      return;
    }
    if(st === 'added'){
      toast("Уже добавлено.");
      return;
    }

    try{
      tg.addToHomeScreen();
      toast("Открываю добавление…");
    }catch(e){
      toast("Ошибка.");
    }
  }

  /* ===== Anti-duplicate submit ===== */
  let __saveInFlight = false;
  let __lastSaveSig = null;
  let __lastSaveAt = 0;

  function makeSaveSignature(payload){
    try{
      return [
        payload.manager,
        payload.restaurant,
        payload.reason,
        String(payload.amount||0),
        payload.start,
        payload.end,
        (payload.comment||'')
      ].join('|');
    }catch(_){
      return String(Date.now());
    }
  }

  function lockPrimaryButton(locked){
    const primaryBtn=document.getElementById('primary-btn');
    if(!primaryBtn) return;
    primaryBtn.disabled=!!locked;
    primaryBtn.classList.toggle('opacity-40', !!locked);
  }

  function render(){
    const container=document.getElementById('view-container');
    const backBtn=document.getElementById('back-btn');
    const title=document.getElementById('header-title');

    container.innerHTML='';
    backBtn.classList.toggle('hidden', state.view==='main');
    document.getElementById('footer-actions').classList.add('hidden');
    document.getElementById('later-btn').classList.remove('hidden');

    if(state.view==='main'){
      title.innerText="KFC";
      container.innerHTML=`
        <div class="grid grid-cols-2 gap-4 mb-8">
          <button onclick="startFlow()" class="ios-card border-live card-anim lens-card p-6 flex flex-col items-center gap-3 border-l-4 border-red-500">
            <div class="lens-layer"></div>
            <div class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center text-[#E4002B]"><i data-lucide="plus"></i></div>
            <span class="font-bold text-[10px] uppercase tracking-widest text-gray-100">Внести потери</span>
          </button>
          <button onclick="navigate('analytics_period')" class="ios-card border-live card-anim lens-card p-6 flex flex-col items-center gap-3">
            <div class="lens-layer"></div>
            <div class="w-12 h-12 bg-green-500/10 rounded-full flex items-center justify-center text-green-300"><i data-lucide="bar-chart-3"></i></div>
            <span class="font-bold text-[10px] uppercase tracking-widest text-gray-100">Аналитика</span>
          </button>
        </div>

        ${db.drafts.length ? `
        <div class="mb-8">
          <p class="text-[9px] font-black uppercase tracking-widest text-gray-200/60 mb-3 px-1">Черновики</p>
          <div class="space-y-3">
            ${db.drafts.map(d=>`
              <div class="relative group">
                <button onclick="resumeDraft('${d.draftId}')" class="w-full ios-card border-live card-anim lens-card p-4 flex items-center justify-between border-l-2 border-red-500/30">
                  <div class="lens-layer"></div>
                  <div class="text-left overflow-hidden mr-2">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="draft-badge">Продолжить</span>
                      <span class="text-[9px] font-bold text-gray-200 uppercase">${d.manager || '...'}</span>
                    </div>
                    <p class="text-xs font-bold truncate">${d.restaurant ? d.restaurant.split(' — ')[1] : 'Новый отчет'}</p>
                  </div>
                  <i data-lucide="chevron-right" class="w-4 h-4 text-gray-200/40"></i>
                </button>
                <button onclick="deleteDraft('${d.draftId}')" class="absolute -right-2 -top-2 bg-black/40 border border-white/10 w-6 h-6 rounded-full flex items-center justify-center text-gray-200 hover:text-red-500 transition-colors btn-liquid">
                  <i data-lucide="x" class="w-3 h-3"></i>
                </button>
              </div>
            `).join('')}
          </div>
        </div>` : ''}

        <button onclick="navigate('history')" class="w-full ios-card border-live card-anim lens-card p-6 flex items-center gap-4">
          <div class="lens-layer"></div>
          <div class="w-10 h-10 bg-blue-500/10 rounded-full flex items-center justify-center text-blue-300"><i data-lucide="history"></i></div>
          <span class="font-bold text-xs uppercase tracking-widest text-gray-100">История записей</span>
        </button>
      `;
    }

    else if (state.view === 'managers') {
      title.innerText = state.editId ? "Менеджер (редактирование)" : "Менеджер";
      container.innerHTML = `
        <div class="search-hint">поиск</div>
        <div class="search-box ios-card border-live lens-card">
          <div class="lens-layer"></div>
          <i data-lucide="search" class="w-4 h-4 text-white/40"></i>
          <input id="search-manager" placeholder="Найти менеджера..." value="${state.searchManager || ''}"
                 oninput="updateSearch('searchManager', this.value, 'search-manager')" />
        </div>
      `;
      const all = Object.keys(dataTU).sort();
      const q = (state.searchManager || '').trim().toLowerCase();
      const list = q ? all.filter(x => x.toLowerCase().includes(q)) : all;
      if (!list.length) container.innerHTML += `<p class="text-center opacity-40 py-10 uppercase text-[10px]">Ничего не найдено</p>`;
      list.forEach(m => {
        container.innerHTML += `<button onclick="state.manager='${m}'; state.searchRestaurant=''; navigate('restaurants')"
          class="w-full p-5 mb-3 ios-card border-live card-anim lens-card text-left font-bold flex justify-between items-center">
          <div class="lens-layer"></div>
          <span>${m}</span><i data-lucide="chevron-right" class="opacity-40"></i></button>`;
      });
    }

    else if (state.view === 'restaurants') {
      title.innerText = "Ресторан";
      container.innerHTML = `
        <div class="search-hint">поиск</div>
        <div class="search-box ios-card border-live lens-card">
          <div class="lens-layer"></div>
          <i data-lucide="search" class="w-4 h-4 text-white/40"></i>
          <input id="search-restaurant" placeholder="Найти ресторан..." value="${state.searchRestaurant || ''}"
                 oninput="updateSearch('searchRestaurant', this.value, 'search-restaurant')" />
        </div>
      `;
      const all = (dataTU[state.manager] || []);
      const q = (state.searchRestaurant || '').trim().toLowerCase();
      const list = q ? all.filter(x => x.toLowerCase().includes(q)) : all;
      if (!list.length) container.innerHTML += `<p class="text-center opacity-40 py-10 uppercase text-[10px]">Ничего не найдено</p>`;
      list.forEach(r => {
        container.innerHTML += `<button onclick="state.restaurant='${r}';navigate('reasons')"
          class="w-full p-4 mb-2 ios-card border-live card-anim lens-card text-left text-xs font-semibold flex justify-between items-center">
          <div class="lens-layer"></div>
          <span>${r}</span><i data-lucide="chevron-right" class="opacity-40"></i></button>`;
      });
    }

    else if (state.view === 'reasons') {
      title.innerText = "Причина";
      ["Внешние факторы","Внутренние факторы","Отсутствие продукта","Персонал"].forEach(r => {
        container.innerHTML += `<button onclick="state.reason='${r}';navigate('comment')"
          class="w-full p-5 mb-3 ios-card border-live card-anim lens-card text-left font-bold flex justify-between items-center">
          <div class="lens-layer"></div>
          <span>${r}</span><i data-lucide="chevron-right" class="opacity-40"></i></button>`;
      });
    }

    else if (state.view === 'comment') {
      title.innerText = "Комментарий";
      container.innerHTML = `<div class="ios-card border-live lens-card p-2">
        <div class="lens-layer"></div>
        <textarea id="comm" class="w-full bg-transparent border-none outline-none text-white p-3 h-32" placeholder="Укажите детали...">${state.comment || ''}</textarea>
      </div>`;
      setPrimary("Далее", () => { state.comment = document.getElementById('comm').value; navigate('calendar'); }, true, true);
    }

    else if (state.view === 'calendar') {
      const isStart = state.stage === 'start';
      const cur = isStart ? state.start : state.end;
      title.innerText = isStart ? "Начало" : "Конец";

      const firstDay = (new Date(cur.year, cur.month, 1).getDay() || 7) - 1;
      const daysInMonth = new Date(cur.year, cur.month + 1, 0).getDate();

      // ГОДА ДО 2030 (включительно): Android/iOS одинаково.
      const yearFrom = 2024;
      const yearTo = 2030;
      const years = Array.from({length: (yearTo - yearFrom + 1)}, (_,i)=>yearFrom+i);

      container.innerHTML = `
        <div class="ios-card border-live lens-card p-5">
          <div class="lens-layer"></div>
          ${!isStart ? `
          <div class="mb-3 p-3 bg-blue-500/10 rounded-xl border border-blue-500/20">
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <p class="text-[8px] uppercase font-black text-blue-300 mb-1 tracking-widest">Начало</p>
                <p class="text-xs font-bold">${state.start.day} ${monthNamesGenitive[state.start.month]} ${pad2(state.start.hour)}:${pad2(state.start.min)}</p>
              </div>
              <button onclick="editStartTime()" class="shrink-0 px-3 py-2 rounded-xl font-bold text-[9px] uppercase tracking-widest bg-white/10 btn-liquid">
                Изменить начало
              </button>
            </div>
          </div>` : ''}

          <div class="flex justify-between items-center mb-6">
            <span class="text-lg font-bold">${cur.day} ${monthNamesGenitive[cur.month]}</span>
            <div class="wheel-box"><div class="wheel" id="h-w"></div><span class="text-blue-300 px-1">:</span><div class="wheel" id="m-w"></div></div>
          </div>

          <div class="flex gap-2 mb-6 justify-center">
            <select onchange="updateFlowDate('month', this.value)" class="ios-select">
              ${monthNames.map((m, i) => `<option value="${i}" ${i === cur.month ? 'selected' : ''}>${m}</option>`).join('')}
            </select>
            <select onchange="updateFlowDate('year', this.value)" class="ios-select">
              ${years.map(y => `<option value="${y}" ${y === cur.year ? 'selected' : ''}>${y}</option>`).join('')}
            </select>
          </div>

          <div class="cal-grid">
            ${['П','В','С','Ч','П','С','В'].map(d => `<div class="text-[10px] text-gray-200/50 font-bold text-center">${d}</div>`).join('')}
            ${Array.from({length:firstDay}).map(() => `<div></div>`).join('')}
            ${Array.from({length:daysInMonth}).map((_, i) => `<div onclick="setDay(${i+1})" class="day-btn ${i+1===cur.day?'selected':''}">${i+1}</div>`).join('')}
          </div>
        </div>
      `;

      initWheels(cur);

      setPrimary(isStart ? "Установить конец" : "Далее", () => {
        const v = getWheels();
        hapticSelect();
        if (isStart) {
          state.start.hour=v.h; state.start.min=v.m;
          state.start.ts = new Date(state.start.year, state.start.month, state.start.day, state.start.hour, state.start.min).getTime();
          state.stage='end';
          // Если конец ещё не задан, стартуем с начала.
          if(!state.end) state.end=JSON.parse(JSON.stringify(state.start));
          else state.end=JSON.parse(JSON.stringify(state.end));
          // Подстрахуем, чтобы конец не отставал от начала при первом заходе.
          state.end.year=state.start.year; state.end.month=state.start.month; state.end.day=state.start.day;
          if(typeof state.end.hour!=="number") state.end.hour=state.start.hour;
          if(typeof state.end.min!=="number") state.end.min=state.start.min;
          state.end.ts = new Date(state.end.year, state.end.month, state.end.day, state.end.hour, state.end.min).getTime();
          render();
        } else {
          state.end.hour=v.h; state.end.min=v.m;
          state.end.ts = new Date(state.end.year, state.end.month, state.end.day, state.end.hour, state.end.min).getTime();
          navigate('sum');
        }
      }, true, true);
    }

    else if (state.view === 'sum') {
      title.innerText = "Сумма";
      container.innerHTML = `
        <div class="ios-card border-live lens-card p-4 mb-4 border-l-4 border-blue-500">
          <div class="lens-layer"></div>
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-[10px] text-gray-200/60 font-black uppercase mb-1 tracking-widest">Период</p>
              <div class="flex items-center gap-2">
                <span class="text-xs font-bold">${pad2(state.start.day)}.${pad2(state.start.month+1)} ${pad2(state.start.hour)}:${pad2(state.start.min)}</span>
                <i data-lucide="arrow-right" class="w-3 h-3 text-gray-200/60"></i>
                <span class="text-xs font-bold">${pad2(state.end.day)}.${pad2(state.end.month+1)} ${pad2(state.end.hour)}:${pad2(state.end.min)}</span>
              </div>
            </div>
            <button onclick="editStartTime(true)" class="shrink-0 px-3 py-2 rounded-xl font-bold text-[9px] uppercase tracking-widest bg-white/10 btn-liquid">
              Изменить время
            </button>
          </div>
        </div>

        <div class="flex flex-col items-center py-12">
          <input type="number" id="sum-input" placeholder="0" value="${state.amount || ''}" class="text-6xl font-black" oninput="scaleSumInput(this)">
          <p class="text-[10px] text-gray-200/60 font-black uppercase mt-4 tracking-widest">Сумма потерь ₸</p>
        </div>
      `;
      setPrimary(state.editId ? "Сохранить" : "Завершить", saveReport, true, true);
      setTimeout(() => { const inp=document.getElementById('sum-input'); if(inp){ inp.focus(); scaleSumInput(inp);} }, 60);
    }

    else if (state.view === 'analytics_period') {
      title.innerText = "Аналитика";
      [{id:'today',n:'Сегодня'},{id:'week',n:'Эта неделя'},{id:'custom',n:'Свой диапазон'},{id:'all',n:'Весь период'}]
      .forEach(opt => {
        const handler = (opt.id === 'custom')
          ? "navigate('analytics_custom')"
          : `state.filter='${opt.id}';navigate('analytics_view')`;

        container.innerHTML += `
          <button onclick="${handler}" class="w-full p-5 mb-3 ios-card border-live card-anim lens-card text-left font-bold flex justify-between items-center">
            <div class="lens-layer"></div>
            <span>${opt.n}</span><i data-lucide="chevron-right" class="opacity-40"></i>
          </button>
        `;
      });
    }

    else if (state.view === 'analytics_custom') {
      title.innerText = "Период";
      const cal = state.analyticsCal;
      const firstDay = (new Date(cal.year, cal.month, 1).getDay() || 7) - 1;
      const daysInMonth = new Date(cal.year, cal.month + 1, 0).getDate();

      container.innerHTML = `
        <div class="ios-card border-live lens-card p-5">
          <div class="lens-layer"></div>
          <div class="flex justify-between items-center mb-6">
            <button onclick="changeCalMonth(-1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 btn-liquid"><i data-lucide="chevron-left"></i></button>
            <span class="font-bold text-sm uppercase tracking-widest">${monthNames[cal.month]} ${cal.year}</span>
            <button onclick="changeCalMonth(1)" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 btn-liquid"><i data-lucide="chevron-right"></i></button>
          </div>

          <div class="cal-grid">
            ${['П','В','С','Ч','П','С','В'].map(d => `<div class="text-[10px] text-gray-200/50 font-bold text-center">${d}</div>`).join('')}
            ${Array.from({length:firstDay}).map(() => `<div></div>`).join('')}
            ${Array.from({length:daysInMonth}).map((_, i) => {
              const ts = new Date(cal.year, cal.month, i+1).getTime();
              const sel = (cal.start && ts === cal.start) || (cal.end && ts === cal.end);
              const rng = cal.start && cal.end && ts > cal.start && ts < cal.end;
              return `<div onclick="setAnalyticsDate(${ts})" class="day-btn ${sel?'selected':''} ${rng?'range':''}">${i+1}</div>`;
            }).join('')}
          </div>
        </div>
      `;

      if (cal.start && cal.end) {
        setPrimary("Показать", () => { state.filter='custom'; navigate('analytics_view'); }, true, false);
      }
    }

    else if (state.view === 'analytics_view') {
      title.innerText = "Итоги";
      const filtered = filterAnalytics(db.reports);
      const totalSum = filtered.reduce((a, b) => a + b.amount, 0);

      container.innerHTML = `
        <div class="ios-card border-live lens-card p-6 mb-4 text-center bg-gradient-to-b from-white/5 to-transparent">
          <div class="lens-layer"></div>
          <p class="text-[10px] text-gray-200/60 font-black uppercase mb-1 tracking-widest">Общие потери</p>
          <h2 class="text-4xl font-black">${totalSum.toLocaleString()} ₸</h2>

          <button onclick="exportExcel()" class="mt-4 w-full flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-[10px] uppercase btn-liquid btn-excel">
            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Скачать Excel
          </button>
        </div>

        <div class="flex border-b border-white/5 mb-6 sticky top-0 bg-black/20 backdrop-blur z-10">
          <button onclick="state.analyticsTab='restaurants';render()" class="tab-btn ${state.analyticsTab==='restaurants'?'active':''}">Рестораны</button>
          <button onclick="state.analyticsTab='reasons';render()" class="tab-btn ${state.analyticsTab==='reasons'?'active':''}">Причины</button>
        </div>

        <div class="space-y-4 pb-24">
          ${state.analyticsTab === 'restaurants' ? renderRestList(filtered, totalSum) : renderReasonList(filtered, totalSum)}
        </div>
      `;
    }

    else if (state.view === 'history') {
      title.innerText = "История";
      if (!db.reports.length) {
        container.innerHTML = `<p class="text-center opacity-30 py-10 uppercase text-[10px]">Нет данных</p>`;
      } else {
        container.innerHTML = `<div class="space-y-3 pb-20">
          ${db.reports.map(r => `
            <div class="ios-card border-live card-anim lens-card p-4">
              <div class="lens-layer"></div>
              <div class="flex justify-between mb-1">
                <span class="text-[9px] font-black text-blue-300 uppercase tracking-widest">${r.manager}</span>
                <span class="text-sm font-black text-red-300">${Number(r.amount).toLocaleString()} ₸</span>
              </div>
              <p class="text-xs font-bold truncate">${(r.restaurant || '').split(' — ')[1] || r.restaurant}</p>
              <p class="text-[8px] text-gray-200/60 uppercase font-bold mt-2">
                ${pad2(r.start.day)}.${pad2(r.start.month+1)} ${pad2(r.start.hour)}:${pad2(r.start.min)}
                —
                ${pad2(r.end.day)}.${pad2(r.end.month+1)} ${pad2(r.end.hour)}:${pad2(r.end.min)}
              </p>

              <div class="flex gap-3 mt-4">
                <button onclick="editReport(${r.id})" class="flex-1 py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest btn-liquid btn-edit">
                  Редактировать
                </button>
                <button onclick="deleteReport(${r.id})" class="px-5 py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest btn-liquid btn-delete">
                  Удалить
                </button>
              </div>
            </div>
          `).join('')}
        </div>`;
      }
    }

    scheduleIcons();
    attachLensHandlers();
    bindScrollHaptics();
    updateA2HSButton();
  }

  function renderRestList(reports, total) {
    const grouped = {};
    reports.forEach(r => { grouped[r.restaurant] = (grouped[r.restaurant] || 0) + r.amount; });
    return Object.entries(grouped).sort((a,b) => b[1] - a[1]).map(([name, sum]) => {
      const perc = total > 0 ? ((sum / total) * 100).toFixed(1) : 0;
      return `<div class="ios-card border-live card-anim lens-card p-4">
        <div class="lens-layer"></div>
        <div class="flex justify-between items-start mb-1">
          <div class="flex flex-col max-w-[70%]">
            <span class="text-xs font-bold truncate">${(name || '').includes(' — ') ? name.split(' — ')[1] : name}</span>
            <span class="text-[9px] text-gray-200/60 font-bold uppercase">${(name || '').includes(' — ') ? name.split(' — ')[0] : ''}</span>
          </div>
          <div class="text-right flex flex-col items-end">
            <span class="text-sm font-black">${sum.toLocaleString()} ₸</span>
            <span class="text-[10px] text-gray-200/60 font-bold">${perc}%</span>
          </div>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${perc}%"></div></div>
      </div>`;
    }).join('') || '<p class="text-center opacity-30 py-10 uppercase text-[10px]">Нет данных.</p>';
  }

  function renderReasonList(reports, total) {
    const grouped = {};
    reports.forEach(r => { grouped[r.reason] = (grouped[r.reason] || 0) + r.amount; });
    return Object.entries(grouped).sort((a,b) => b[1] - a[1]).map(([reason, sum]) => {
      const perc = total > 0 ? ((sum / total) * 100).toFixed(1) : 0;
      return `<div class="ios-card border-live card-anim lens-card p-4">
        <div class="lens-layer"></div>
        <div class="flex justify-between items-center mb-1">
          <span class="text-xs font-bold uppercase tracking-tight">${reason}</span>
          <div class="text-right flex flex-col items-end">
            <span class="text-sm font-black text-red-300">${sum.toLocaleString()} ₸</span>
            <span class="text-[10px] text-gray-200/60 font-bold">${perc}%</span>
          </div>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${perc}%"></div></div>
      </div>`;
    }).join('') || '<p class="text-center opacity-30 py-10 uppercase text-[10px]">Нет данных.</p>';
  }

  function saveDraft() {
    if (state.view === 'calendar') {
      const v = getWheels();
      if (state.stage === 'start') { state.start.hour=v.h; state.start.min=v.m; }
      else { state.end.hour=v.h; state.end.min=v.m; }
    }
    if (state.view === 'comment') state.comment = document.getElementById('comm').value;
    if (state.view === 'sum') state.amount = parseInt(document.getElementById('sum-input').value) || 0;

    if (!state.draftId) state.draftId = 'd_' + Date.now();
    const idx = db.drafts.findIndex(d => d.draftId === state.draftId);
    if (idx !== -1) db.drafts[idx] = JSON.parse(JSON.stringify(state));
    else db.drafts.push(JSON.parse(JSON.stringify(state)));

    saveDraftsToLS();
    state.view='main'; historyStack=['main']; render();
    hapticImpact("light");
  }

  function resumeDraft(id) {
    const d = db.drafts.find(it => it.draftId === id);
    if (!d) return;

    // Возвращаемся ровно в то место, где был пользователь (а не принудительно в calendar/end).
    state = JSON.parse(JSON.stringify(d));

    // Подстраховка: обязательные поля.
    if(!state.start) state.start=getNowObj();
    if(!state.end) state.end=JSON.parse(JSON.stringify(state.start));
    if(!state.stage) state.stage='start';
    if(!state.view || state.view==='main') state.view='managers';
    if(!state.analyticsCal) state.analyticsCal={ month:new Date().getMonth(), year:new Date().getFullYear(), start:null, end:null };
    if(!state.analyticsTab) state.analyticsTab='restaurants';
    if(!state.searchManager) state.searchManager='';
    if(!state.searchRestaurant) state.searchRestaurant='';
    if(!state.draftId) state.draftId=id;

    // История: минимум (назад в main работает корректно).
    historyStack = ['main', state.view];

    render();
    hapticImpact("light");
  }

  function deleteDraft(id) {
    db.drafts = db.drafts.filter(d => d.draftId !== id);
    saveDraftsToLS();
    render();
    hapticImpact("medium");
  }

  function exportExcelServer() {
  const url = `${window.location.origin}${API}/export.xlsx`;
  hapticImpact("light");

  try {
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } catch (e) {
    window.open(url, '_blank');
  }
}

  function splitRestaurant(r){
    const s = (r || '');
    if(s.includes(' — ')){
      const parts = s.split(' — ');
      return { code: parts[0] || '', name: parts.slice(1).join(' — ') || '' };
    }
    return { code:'', name:s };
  }

  function fmtDateObj(o){
    if(!o) return '';
    return `${pad2(o.day)}.${pad2(o.month+1)}.${o.year} ${pad2(o.hour)}:${pad2(o.min)}`;
  }

  async function exportExcel(){
    try{
      // Если ExcelJS недоступен, падаем на серверный экспорт.
      if(typeof ExcelJS === "undefined" || !ExcelJS?.Workbook){
        exportExcelServer();
        return;
      }

      const filtered = filterAnalytics(db.reports);
      const rows = (filtered || []).slice().sort((a,b)=> (b.amount||0) - (a.amount||0)); // от больших потерь к меньшим.

      const wb = new ExcelJS.Workbook();
      wb.creator = 'KFC Loss Control';
      wb.created = new Date();

      const ws = wb.addWorksheet('Reports', {
        views: [{ state: 'frozen', ySplit: 1 }]
      });

      const header = ["ID","Менеджер","Ресторан код","Ресторан","Причина","Сумма","Начало","Конец","Комментарий"];
      ws.addRow(header);

      for(const r of rows){
        const rr = splitRestaurant(r.restaurant);
        ws.addRow([
          Number(r.id)||'',
          r.manager||'',
          rr.code||'',
          rr.name||'',
          r.reason||'',
          Number(r.amount)||0,
          fmtDateObj(r.start),
          fmtDateObj(r.end),
          r.comment||''
        ]);
      }

      // Ширины.
      ws.columns = [
        { width: 10 }, // ID
        { width: 22 }, // Менеджер
        { width: 14 }, // Код
        { width: 28 }, // Ресторан
        { width: 18 }, // Причина
        { width: 14 }, // Сумма
        { width: 18 }, // Начало
        { width: 18 }, // Конец
        { width: 34 }  // Комментарий
      ];

      // Оформление заголовка + автофильтр (важно: фильтры сразу доступны).
      const headerRow = ws.getRow(1);
      headerRow.font = { bold: true };
      headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
      headerRow.height = 20;

      // Автофильтр по заголовку.
      ws.autoFilter = { from: 'A1', to: 'I1' };

      // Формат суммы.
      ws.getColumn(6).numFmt = '#,##0';

      // Выравнивание по умолчанию.
      ws.eachRow((row, rowNumber) => {
        if(rowNumber === 1) return;
        row.alignment = { vertical: 'top', horizontal: 'left', wrapText: true };
      });

      const rangeLabel = (()=>{
        if(!rows.length) return 'empty';
        const minTs = Math.min(...rows.map(x=>Number(x.start?.ts||x.created_at||Date.now())));
        const maxTs = Math.max(...rows.map(x=>Number(x.start?.ts||x.created_at||Date.now())));
        const a = new Date(minTs);
        const b = new Date(maxTs);
        return `${pad2(a.getDate())}.${pad2(a.getMonth()+1)}_${pad2(b.getDate())}.${pad2(b.getMonth()+1)}`;
      })();

      const filename = `KFC_Loss_${rangeLabel}.xlsx`;
      toast("Готовлю Excel...");

      const buf = await wb.xlsx.writeBuffer();
      const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);

      // Надёжная загрузка (и в TG WebView, и в браузере).
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.style.display='none';
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>URL.revokeObjectURL(url), 8000);

      toast("Excel готов.");
      hapticImpact("light");
    }catch(e){
      toast("Ошибка Excel.");
      exportExcelServer();
    }
  }

  async function saveReport() {
    const val = parseInt(document.getElementById('sum-input')?.value || "0") || 0;
    if (val <= 0) return;

    // Защита от двойного клика/двойной отправки.
    if(__saveInFlight) return;

    state.amount = val;

    const startStr = `${pad2(state.start.day)}.${pad2(state.start.month+1)}.${state.start.year} ${pad2(state.start.hour)}:${pad2(state.start.min)}`;
    const endStr   = `${pad2(state.end.day)}.${pad2(state.end.month+1)}.${state.end.year} ${pad2(state.end.hour)}:${pad2(state.end.min)}`;

    const payload = {
      manager: state.manager,
      restaurant: state.restaurant,
      reason: state.reason,
      amount: state.amount,
      start: startStr,
      end: endStr,
      comment: state.comment || '-'
    };

    const sig = makeSaveSignature(payload);
    const now = Date.now();
    // Если пришёл второй такой же сабмит в течение 8 секунд — игнорируем.
    if(__lastSaveSig === sig && (now - __lastSaveAt) < 8000) return;

    __saveInFlight = true;
    __lastSaveSig = sig;
    __lastSaveAt = now;

    // Idempotency key (если бэкенд поддержит — полностью уберёт дубли).
    if(!state.clientRequestId){
      state.clientRequestId = 'req_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    }

    toast("Сохраняю...");
    lockPrimaryButton(true);

    try {
      const isEdit = !!state.editId;

      await apiJson(isEdit ? `${API}/reports/${state.editId}` : `${API}/reports`, {
        method: isEdit ? "PUT" : "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Idempotency-Key": state.clientRequestId
        },
        body: JSON.stringify(payload)
      }, 15000);

      await loadReportsFromServer();

      if (state.draftId) {
        db.drafts = db.drafts.filter(d => d.draftId !== state.draftId);
        saveDraftsToLS();
      }

      state.view='main'; historyStack=['main']; state.editId=null;
      state.clientRequestId = null;
      render();
      toast("Готово");
      hapticImpact("medium");
    } catch (e) {
      toast("Ошибка");
      alert(`Ошибка: ${e?.message || 'unknown'}`);
    } finally {
      __saveInFlight = false;
      lockPrimaryButton(false);
    }
  }

  function editStartTime(fromSum=false){
    // Возвращаем в календарь на редактирование начала (важно для "закрыть позже" + продолжить).
    state.stage = 'start';
    if(!state.start) state.start=getNowObj();
    if(!state.end) state.end=JSON.parse(JSON.stringify(state.start));
    if(fromSum){
      // sum -> calendar: добавим корректную историю.
      historyStack = ['main','calendar'];
      state.view='calendar';
      render();
      hapticSelect();
      return;
    }
    render();
    hapticSelect();
  }

  function editReport(id) {
    const r = db.reports.find(x => x.id === id);
    if (!r) return;

    state = {
      view:'comment',
      manager: r.manager,
      restaurant: r.restaurant,
      reason: r.reason,
      comment: r.comment || '',
      start: JSON.parse(JSON.stringify(r.start)),
      end: JSON.parse(JSON.stringify(r.end)),
      stage:'start',
      amount: r.amount || 0,
      filter: state.filter,
      analyticsCal: state.analyticsCal,
      analyticsTab: state.analyticsTab || 'restaurants',
      draftId: null,
      editId: id,
      searchManager: state.searchManager || '',
      searchRestaurant: state.searchRestaurant || '',
      homeScreenStatus: state.homeScreenStatus || null,
      clientRequestId: null
    };

    historyStack = ['main','history','comment'];
    render();
    hapticImpact("light");
  }

  async function deleteReport(id) {
    if (!confirm("Удалить этот инцидент?")) return;
    toast("Удаляю...");
    try {
      await apiJson(`${API}/reports/${id}`, { method: "DELETE" }, 15000);
      await loadReportsFromServer();
      render();
      toast("Удалено");
      hapticImpact("medium");
    } catch (e) {
      toast("Ошибка");
      alert("Ошибка: " + (e?.message || e));
    }
  }

  function startFlow() {
    state = {
      view:'managers',
      manager:'', restaurant:'', reason:'', comment:'',
      start:getNowObj(),
      end:getNowObj(),
      stage:'start',
      amount:0,
      filter: state.filter,
      analyticsCal: state.analyticsCal,
      analyticsTab: 'restaurants',
      draftId: null,
      editId: null,
      searchManager: state.searchManager || '',
      searchRestaurant: '',
      homeScreenStatus: state.homeScreenStatus || null,
      clientRequestId: null
    };
    navigate('managers');
  }

  function navigate(v){
    historyStack.push(v);
    state.view=v;
    render();
    hapticSelect();
  }

  function goBack(){
    if(historyStack.length>1){
      historyStack.pop();
      state.view=historyStack[historyStack.length-1];
      render();
      hapticSelect();
    }
  }

  function setDay(d){ if(state.stage==='start') state.start.day=d; else state.end.day=d; render(); hapticSelect(); }
  function updateFlowDate(p,v){ const cur=state.stage==='start'?state.start:state.end; cur[p]=parseInt(v); render(); hapticSelect(); }

  function setAnalyticsDate(ts){
    if(!state.analyticsCal.start || (state.analyticsCal.start && state.analyticsCal.end)){
      state.analyticsCal.start=ts; state.analyticsCal.end=null;
    } else {
      if(ts < state.analyticsCal.start){ state.analyticsCal.end=state.analyticsCal.start; state.analyticsCal.start=ts; }
      else state.analyticsCal.end=ts;
    }
    render();
    hapticSelect();
  }

  function changeCalMonth(s){
    state.analyticsCal.month += s;
    if(state.analyticsCal.month>11){state.analyticsCal.month=0;state.analyticsCal.year++;}
    if(state.analyticsCal.month<0){state.analyticsCal.month=11;state.analyticsCal.year--;}
    render();
    hapticSelect();
  }

  function scaleSumInput(input){
    const val=input.value;
    if(val.length>7) input.style.fontSize='32px';
    else if(val.length>5) input.style.fontSize='44px';
    else input.style.fontSize='60px';
  }

  function filterAnalytics(reports){
    const now=new Date();
    const startOfToday=new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    return (reports||[]).filter(r => {
      const ts = r.start?.ts || r.created_at || 0;
      if(state.filter==='today') return ts >= startOfToday;
      if(state.filter==='week') {
        const dow = (now.getDay() || 7) - 1;
        const startOfWeek = startOfToday - dow * 86400000;
        return ts >= startOfWeek;
      }
      if(state.filter==='custom') {
        if (!state.analyticsCal.start || !state.analyticsCal.end) return true;
        return ts >= state.analyticsCal.start && ts <= (state.analyticsCal.end + 86400000);
      }
      return true;
    });
  }

  function initWheels(t){
    setTimeout(() => {
      const h=document.getElementById('h-w'), m=document.getElementById('m-w');
      if(!h || !m) return;
      h.innerHTML=Array.from({length:24},(_,i)=>`<div class="wheel-item">${pad2(i)}</div>`).join('');
      m.innerHTML=Array.from({length:60},(_,i)=>`<div class="wheel-item">${pad2(i)}</div>`).join('');
      h.scrollTop=t.hour*52; m.scrollTop=t.min*52;

      const sync=(el)=>{
        const idx=Math.round(el.scrollTop/52);
        el.querySelectorAll('.wheel-item').forEach((it,i)=>it.classList.toggle('active', i===idx));
      };
      h.onscroll=()=>sync(h); m.onscroll=()=>sync(m);
      sync(h); sync(m);
    }, 10);
  }

  function getWheels(){
    const h=document.getElementById('h-w'), m=document.getElementById('m-w');
    return { h: h ? Math.round(h.scrollTop/52) : 0, m: m ? Math.round(m.scrollTop/52) : 0 };
  }

  /* ===== Haptics on scroll (мягко) ===== */
  let _scrollTick=0;
  function bindScrollHaptics(){
    const main=document.getElementById('view-container');
    if(!main || main.__hBound) return;
    main.__hBound=true;
    main.addEventListener('scroll',()=>{
      const now=Date.now();
      if(now-_scrollTick>650){
        _scrollTick=now;
        hapticSelect();
      }
    },{passive:true});
  }

  /* ===== ПАРАЛЛАКС + SPOTLIGHT + АВТОВОЛНА (оптимизировано для iOS) ===== */
  const rootStyle=document.documentElement.style;
  let pointerX=0, pointerY=0;
  let smoothX=0, smoothY=0;
  let smoothS=0;

  let spotX=0.5, spotY=0.4;
  let smoothSpotX=0.5, smoothSpotY=0.4;
  let targetSpotOpacity=0.0;
  let smoothSpotOpacity=0.0;

  function setParallaxFromPointer(clientX, clientY){
    const w=window.innerWidth||1;
    const h=window.innerHeight||1;
    const nx=(clientX/w-0.5);
    const ny=(clientY/h-0.5);
    pointerX = nx * 30;
    pointerY = ny * 30;

    spotX=Math.min(1,Math.max(0,clientX/w));
    spotY=Math.min(1,Math.max(0,clientY/h));
  }

  function setParallaxFromScroll(){
    const main=document.getElementById('view-container');
    if(!main) return 0;
    const s=main.scrollTop||0;
    return -(s*0.026);
  }

  function spotlightOn(){ targetSpotOpacity=1.0; }
  function spotlightSoft(){ targetSpotOpacity=0.64; }
  function spotlightOff(){ targetSpotOpacity=0.0; }

  window.addEventListener('mousemove',(e)=>{ setParallaxFromPointer(e.clientX,e.clientY); spotlightSoft(); },{passive:true});
  window.addEventListener('mouseleave',()=>spotlightOff(),{passive:true});
  window.addEventListener('touchstart',(e)=>{ const t=e.touches&&e.touches[0]; if(t) setParallaxFromPointer(t.clientX,t.clientY); spotlightOn(); },{passive:true});
  window.addEventListener('touchmove',(e)=>{ const t=e.touches&&e.touches[0]; if(t) setParallaxFromPointer(t.clientX,t.clientY); spotlightOn(); },{passive:true});
  window.addEventListener('touchend',()=>spotlightOff(),{passive:true});
  window.addEventListener('touchcancel',()=>spotlightOff(),{passive:true});

  let _t0=performance.now();

  // iOS “дорого и плавно”: фон обновляем реже, а во время скролла замораживаем
  let _lastFrame = 0;
  function getTargetFps(){
    if (!isIOS) return 60;
    // on iOS: softer background FPS
    if (document.body.classList.contains('is-scrolling')) return 0; // freeze
    return 40; // smooth + light
  }

  function rafParallax(now){
    const targetFps = getTargetFps();
    if (targetFps === 0) {
      // keep checking for inertia end (and remove class smoothly)
      if (isIOS) {
        const dt = now - (__scrollLastTs || 0);
        if (dt > 180 && document.body.classList.contains('is-scrolling')) {
          __scrolling = false;
          document.body.classList.remove('is-scrolling');
        }
      }
      requestAnimationFrame(rafParallax);
      return;
    }

    const minDt = 1000 / targetFps;
    if (_lastFrame && (now - _lastFrame) < minDt) {
      requestAnimationFrame(rafParallax);
      return;
    }
    _lastFrame = now;

    const t=(now-_t0)/1000;

    const ax = (Math.sin(t*1.18)*30 + Math.sin(t*0.48)*18 + Math.sin(t*0.20)*12);
    const ay = (Math.cos(t*1.04)*28 + Math.cos(t*0.42)*16 + Math.cos(t*0.18)*12);
    const shine = (Math.sin(t*1.38)*0.08 + Math.sin(t*0.50)*0.06);

    rootStyle.setProperty('--ax', ax.toFixed(2)+'px');
    rootStyle.setProperty('--ay', ay.toFixed(2)+'px');
    rootStyle.setProperty('--shine', Math.max(0.10, Math.min(0.26, 0.18 + shine)).toFixed(3));

    const targetS=setParallaxFromScroll();

    smoothX += (pointerX - smoothX)*0.075;
    smoothY += (pointerY - smoothY)*0.075;
    smoothS += (targetS - smoothS)*0.085;

    rootStyle.setProperty('--px', smoothX.toFixed(2)+'px');
    rootStyle.setProperty('--py', smoothY.toFixed(2)+'px');
    rootStyle.setProperty('--ps', smoothS.toFixed(2)+'px');

    smoothSpotX += (spotX - smoothSpotX)*0.095;
    smoothSpotY += (spotY - smoothSpotY)*0.095;
    smoothSpotOpacity += (targetSpotOpacity - smoothSpotOpacity)*0.095;

    rootStyle.setProperty('--sx', (smoothSpotX*100).toFixed(2)+'%');
    rootStyle.setProperty('--sy', (smoothSpotY*100).toFixed(2)+'%');
    rootStyle.setProperty('--sop', smoothSpotOpacity.toFixed(3));

    // extra: if inertia ended but class still present, clear it
    if (isIOS && document.body.classList.contains('is-scrolling')) {
      const dt = now - (__scrollLastTs || 0);
      if (dt > 180) {
        __scrolling = false;
        document.body.classList.remove('is-scrolling');
      }
    }

    requestAnimationFrame(rafParallax);
  }

  /* ===== ЛИНЗА (восстановлено) ===== */
  function attachLensHandlers(){
    const cards = document.querySelectorAll('.lens-card');
    cards.forEach(card => {
      if (card.__lensBound) return;
      card.__lensBound = true;

      const setXY = (clientX, clientY) => {
        const r = card.getBoundingClientRect();
        const x = ((clientX - r.left) / Math.max(1, r.width)) * 100;
        const y = ((clientY - r.top) / Math.max(1, r.height)) * 100;
        card.style.setProperty('--lx', Math.min(100, Math.max(0, x)).toFixed(2) + '%');
        card.style.setProperty('--ly', Math.min(100, Math.max(0, y)).toFixed(2) + '%');
      };

      card.addEventListener('mousemove', (e) => setXY(e.clientX, e.clientY), { passive:true });
      card.addEventListener('mouseleave', () => card.style.setProperty('--lpress', '0'), { passive:true });

      card.addEventListener('touchstart', (e) => {
        const t = e.touches && e.touches[0];
        if (t) setXY(t.clientX, t.clientY);
        card.style.setProperty('--lpress', '1');
      }, { passive:true });

      card.addEventListener('touchmove', (e) => {
        const t = e.touches && e.touches[0];
        if (t) setXY(t.clientX, t.clientY);
        card.style.setProperty('--lpress', '1');
      }, { passive:true });

      card.addEventListener('touchend', () => card.style.setProperty('--lpress', '0'), { passive:true });
      card.addEventListener('touchcancel', () => card.style.setProperty('--lpress', '0'), { passive:true });

      card.addEventListener('mousedown', () => card.style.setProperty('--lpress', '1'), { passive:true });
      window.addEventListener('mouseup', () => card.style.setProperty('--lpress', '0'), { passive:true });
    });
  }

  window.addEventListener('load',()=>{
    try{
      render();
      bindScrollHaptics();

      // Android — не запускаем тяжёлый rafParallax вообще (фон выключен CSS-ом).
      // iOS / desktop — как было.
      if (!isAndroid) {
        requestAnimationFrame(rafParallax);
      }

      // Android: статус "ярлык на экран" (Telegram API).
      bindHomeScreenStatus();

      toast("Загрузка...");
      loadReportsFromServer()
        .then(()=>{ render(); toast("Готово"); })
        .catch(()=>{ toast("Без данных (временно)"); });
    }catch(e){
      alert("Ошибка интерфейса: " + (e?.message || e));
    }
  });
</script>
</body>
</html>
